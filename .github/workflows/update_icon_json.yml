name: Update icon JSON

on:
  push:
    paths:
      - 'icon/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-json:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Generate JSON file (Loon Compatible)
      env:
        CURRENT_REPO: ${{ github.repository }} 
        CURRENT_BRANCH: ${{ github.ref_name }}
      run: |
        node << 'EOF'
        const fs = require('fs');
        const path = require('path');

        const repo = process.env.CURRENT_REPO;
        const branch = process.env.CURRENT_BRANCH;
        
        if (!repo || !branch) {
          console.error("Error: Could not detect repository context.");
          process.exit(1);
        }

        const rootDir = process.cwd();
        const iconDir = path.join(rootDir, 'icon');
        const jsonPath = path.join(rootDir, 'icon.json');

        console.log(`[Info] Scanning: ${iconDir}`);

        try {
          if (!fs.existsSync(iconDir)) {
             console.log("No icon directory found.");
             process.exit(0);
          }

          const validExtensions = new Set(['.png', '.jpg', '.jpeg', '.svg', '.webp']);
          
          const files = fs.readdirSync(iconDir)
            .filter(file => validExtensions.has(path.extname(file).toLowerCase()))
            .sort();

          // [核心修复 1] 构建 icons 数组，并移除文件后缀
          const iconsList = files.map(file => ({
            name: path.parse(file).name, // 移除 .png, 变成纯文件名 "App"
            url: `https://raw.githubusercontent.com/${repo}/${branch}/icon/${file}`
          }));

          // [核心修复 2] 构建符合 Loon 标准的根对象结构
          const finalOutput = {
            name: "自用图标资源库", // 集合显示名称
            description: `Auto-updated on ${new Date().toISOString().split('T')[0]}`,
            icons: iconsList
          };

          fs.writeFileSync(jsonPath, JSON.stringify(finalOutput, null, 2));
          console.log(`[Success] Generated Loon-compatible JSON with ${iconsList.length} icons.`);
        
        } catch (error) {
          console.error('[Error]', error.message);
          process.exit(1);
        }
        EOF

    - name: Commit and Push changes
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        if [[ -n $(git status --porcelain icon.json) ]]; then
          git add icon.json
          git commit -m "chore(auto): update icon.json format for Loon [skip ci]"
          git push
        else
          echo "No changes detected."
        fi
